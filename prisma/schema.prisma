// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "jurfis"]
}

// ============================================================================
// SCHEMA: public
// Authentication and User Management
// ============================================================================

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  password            String
  emailVerified       DateTime?
  image               String?
  organizationMembers OrganizationMember[]
  overtimeRecords     OvertimeRecord[]

  // CCR Module Relations
  partsCreated         Part[]            @relation("PartCreatedBy")
  contactsCreated      Contact[]         @relation("ContactCreatedBy")
  protocolsCreated     Protocol[]        @relation("ProtocolEmployee")
  tramitationsCreated  Tramitation[]     @relation("TramitationCreatedBy")
  sessionsCreated      Session[]         @relation("SessionCreatedBy")
  minutesCreated       SessionMinutes[]  @relation("MinutesCreatedBy")
  notificationsCreated Notification[]    @relation("NotificationCreatedBy")
  documentsUploaded    Document[]        @relation("DocumentUploadedBy")
  publicationsCreated  Publication[]     @relation("PublicationCreatedBy")
  historyCreated       ResourceHistory[] @relation("HistoryCreatedBy")

  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  hasCompletedOnboarding Boolean   @default(false)
  lastOnboardingDate     DateTime?

  @@map("User")
  @@schema("public")
}

model Organization {
  id              String               @id @default(cuid())
  name            String
  slug            String               @unique
  members         OrganizationMember[]
  overtimeRecords OvertimeRecord[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@map("Organization")
  @@schema("public")
}

model OrganizationMember {
  id             String           @id @default(cuid())
  userId         String
  organizationId String
  role           OrganizationRole
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([userId, organizationId])
  @@map("OrganizationMember")
  @@schema("public")
}

enum OrganizationRole {
  ADMIN
  EMPLOYEE
  EXTERNAL

  @@schema("public")
}

// ============================================================================
// SCHEMA: jurfis
// Scheduling System (Meeting Management)
// ============================================================================

model Meeting {
  id              String        @id @default(cuid())
  title           String
  date            DateTime
  startTime       String
  endTime         String
  requestedBy     String?
  email           String?
  phone           String?
  contacts        String?
  notes           String?       @db.Text
  status          MeetingStatus @default(APPROVED)
  rejectionReason String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("Scheduling_Meeting")
  @@schema("jurfis")
}

enum MeetingStatus {
  PENDING
  APPROVED
  REJECTED

  @@schema("jurfis")
}

// ============================================================================
// SCHEMA: jurfis
// Overtime System (Employee Overtime Tracking)
// ============================================================================

model OvertimeRecord {
  id                 String       @id @default(cuid())
  userId             String
  organizationId     String
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  month              Int // 1-12
  year               Int // 2024, 2025...
  extraHours         Float // Horas extras do mês
  lateHours          Float // Horas de atraso
  balance            Float // extraHours - lateHours
  accumulatedBalance Float // Saldo acumulado até este mês
  documentPath       String? // Caminho do arquivo no servidor de rede
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@index([userId, organizationId, year, month])
  @@index([organizationId])
  @@map("Overtime_Record")
  @@schema("jurfis")
}

// ============================================================================
// SCHEMA: jurfis
// CCR System (Conselho de Contribuintes do Recife)
// ============================================================================

// ============================================
// TABELA DE PARTES E RELACIONAMENTO
// ============================================
model Part {
  id String @id @default(uuid())

  // Informações da parte (pessoa única dentro de um processo)
  name          String // Nome completo da parte
  role          PartRole // Papel no processo (REQUERENTE, PATRONO, etc)
  processNumber String // Número do processo ao qual esta parte pertence

  // Campos específicos para PATRONO
  registrationType   String? // Tipo de registro (ex: OAB, CRC)
  registrationNumber String? // Número do registro

  // Relacionamentos
  protocols   ProtocolPart[] // Protocolos que usam esta parte
  contacts    Contact[] // Contatos da parte (telefones/emails)
  attendances SessionResourceAttendance[] // Presenças em julgamentos

  // Status
  isActive Boolean @default(true) // Parte ativa (soft delete)

  // Auditoria
  createdBy     String
  createdByUser User     @relation("PartCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([name, role, processNumber]) // Uma pessoa com mesmo nome e role é única dentro do processo
  @@index([name])
  @@index([role])
  @@index([processNumber])
  @@map("CCR_Part")
  @@schema("jurfis")
}

// ============================================
// TABELA DE CONTATOS
// ============================================
model Contact {
  id String @id @default(uuid())

  // Vinculação obrigatória à parte
  partId String
  part   Part   @relation(fields: [partId], references: [id], onDelete: Restrict)

  // Vinculação ao protocolo que criou este contato
  protocolId String
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // Número do processo (para consultas futuras)
  processNumber String

  // Informações do contato
  type  ContactType // TELEFONE ou EMAIL
  value String // Número do telefone ou endereço de email

  // Marcadores
  isPrimary  Boolean @default(false) // Contato principal da parte
  isVerified Boolean @default(false) // Contato verificado
  isActive   Boolean @default(true) // Contato ativo (soft delete)

  // Auditoria
  createdBy     String?
  createdByUser User?    @relation("ContactCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([partId])
  @@index([protocolId])
  @@index([processNumber])
  @@index([type])
  @@index([value]) // Para busca rápida por email/telefone
  @@map("CCR_Contact")
  @@schema("jurfis")
}

// ============================================
// TABELA DE PROTOCOLOS E RELACIONAMENTO
// ============================================
model Protocol {
  id             String         @id @default(uuid())
  number         String         @unique // "XXX/MM-YYYY"
  sequenceNumber Int // XXX
  month          Int // MM (1-12)
  year           Int // YYYY
  processNumber  String // Número do processo
  presenter      String // Apresentante
  employeeId     String // Quem fez o protocolo
  employee       User           @relation("ProtocolEmployee", fields: [employeeId], references: [id])
  status         ProtocolStatus @default(PENDENTE) // PENDENTE, CONCLUIDO, ARQUIVADO
  archiveReason  String?        @db.Text // Justificativa quando status = ARQUIVADO

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  parts        ProtocolPart[] // Partes envolvidas no protocolo (N:N)
  contacts     Contact[] // Contatos criados neste protocolo
  resource     Resource? // Só existe se isAdmittedAsResource = true
  tramitations Tramitation[]

  @@index([year, month, sequenceNumber])
  @@index([processNumber])
  @@map("CCR_Protocol")
  @@schema("jurfis")
}

model ProtocolPart {
  id String @id @default(uuid())

  protocolId String
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  partId String
  part   Part   @relation(fields: [partId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([protocolId, partId]) // Uma parte não pode ser adicionada duas vezes ao mesmo protocolo
  @@index([protocolId])
  @@index([partId])
  @@map("CCR_ProtocolPart")
  @@schema("jurfis")
}

// ============================================
// TABELA DE RECURSOS
// ============================================
model Resource {
  id             String @id @default(uuid())
  resourceNumber String @unique // "XXXX/YYYY"
  sequenceNumber Int // XXXX
  year           Int // YYYY

  protocolId String   @unique
  protocol   Protocol @relation(fields: [protocolId], references: [id])

  status ResourceStatus @default(EM_ANALISE)
  type   ResourceType // VOLUNTARIO ou OFICIO

  // Informações do processo
  processNumber     String
  processName       String? // Nome/Descrição do processo
  attachedProcesses String[] @default([]) // Processos apensos

  // Informações do acórdão (gerado após julgamento)
  decisionNumber         String? @unique // "XXXX/YYYY"
  decisionSequenceNumber Int? // XXXX
  decisionYear           Int? // YYYY

  // Relacionamentos
  // Partes são acessadas via processNumber: Part.findMany({ where: { processNumber } })
  subjects       SubjectChildren[] // Assuntos do recurso (many-to-many com hierarquia)
  registrations  Registration[] // Inscrições e valores do recurso
  authorities    Authority[] // Autoridades vinculadas ao recurso
  addresses      Address[] // Endereços vinculados ao recurso
  sessions       SessionResource[]
  distributions  SessionDistribution[]
  documents      Document[]
  publications   Publication[]
  history        ResourceHistory[]
  notifications  Notification[]
  sessionResults SessionResult[]   @relation("ResourceSessionResults") // Resultados de votações do processo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year, sequenceNumber])
  @@index([decisionYear, decisionSequenceNumber])
  @@index([status])
  @@index([type])
  @@map("CCR_Resource")
  @@schema("jurfis")
}

// ============================================
// ENDEREÇOS
// ============================================
model Address {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  type         AddressType
  cep          String?
  street       String // Rua/Logradouro
  number       String? // Número
  complement   String? // Complemento
  neighborhood String? // Bairro
  city         String // Cidade
  state        String // Estado (UF)

  isPrimary Boolean @default(false)
  isActive  Boolean @default(true) // Endereço ativo (soft delete)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId])
  @@index([type])
  @@map("CCR_Address")
  @@schema("jurfis")
}

// ============================================
// TABELA DE PUBLICAÇÕES
// ============================================
model Publication {
  id String @id @default(uuid())

  type              PublicationType
  publicationNumber String
  publicationDate   DateTime

  resourceId String?
  resource   Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  sessionId  String?
  session    Session?  @relation(fields: [sessionId], references: [id])

  // Snapshot da pauta (apenas para publicações de sessão)
  sessionSnapshots PublicationSessionSnapshot[]

  createdBy     String
  createdByUser User     @relation("PublicationCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([resourceId])
  @@index([sessionId])
  @@index([type])
  @@index([publicationDate])
  @@map("CCR_Publication")
  @@schema("jurfis")
}

// Snapshot da pauta no momento da publicação
model PublicationSessionSnapshot {
  id String @id @default(uuid())

  publicationId String
  publication   Publication @relation(fields: [publicationId], references: [id], onDelete: Cascade)

  // Dados do processo na pauta
  resourceId    String
  processNumber String
  processName   String?
  order         Int
  status        String

  // Dados da distribuição no momento da publicação
  firstDistributionId   String? // Relator
  firstDistributionName String?
  reviewersIds          String[] @default([]) // IDs dos revisores
  reviewersNames        String[] @default([]) // Nomes dos revisores
  distributedToId       String // Para quem foi distribuído nesta sessão
  distributedToName     String

  createdAt DateTime @default(now())

  @@index([publicationId])
  @@index([resourceId])
  @@map("CCR_PublicationSessionSnapshot")
  @@schema("jurfis")
}

// ============================================
// TABELA DE INSCRIÇÕES
// ============================================
model Registration {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  type               RegistrationType // IMOBILIARIA, ECONOMICA, CPF, CNPJ
  registrationNumber String // Número da inscrição

  // Endereço da inscrição
  cep          String?
  street       String? // Rua
  number       String? // Número
  complement   String? // Complemento
  neighborhood String? // Bairro
  city         String? // Cidade
  state        String? // Estado (UF)

  // Relacionamentos
  values RegistrationValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId])
  @@map("CCR_Registration")
  @@schema("jurfis")
}

model RegistrationValue {
  id             String       @id @default(uuid())
  registrationId String
  registration   Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  description String? // Descrição do valor (ex: "Principal", "Multa", "Juros")
  amount      Decimal   @db.Decimal(15, 2)
  dueDate     DateTime? // Data de vencimento

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([registrationId])
  @@map("CCR_RegistrationValue")
  @@schema("jurfis")
}

// ============================================
// TABELA DE TRAMITAÇÕES
// ============================================
model Tramitation {
  id            String    @id @default(uuid())
  protocolId    String?
  protocol      Protocol? @relation(fields: [protocolId], references: [id])
  processNumber String // Número do processo

  purpose TramitationPurpose // SOLICITAR_PROCESSO, CONTRARRAZAO, JULGAMENTO, etc

  // Destino da tramitação (3 opções, pelo menos uma obrigatória):

  // Opção 1: Setor (FK para tabela Sector)
  sectorId String?
  sector   Sector? @relation(fields: [sectorId], references: [id])

  // Opção 2: Membro/Conselheiro (FK para tabela Member)
  memberId String?
  member   Member? @relation(fields: [memberId], references: [id])

  // Opção 3: Destino (texto livre)
  destination String? // Para quando não é setor nem membro específico

  requestDate  DateTime          @default(now())
  deadline     DateTime? // Prazo limite
  returnDate   DateTime? // Data de retorno (quando voltar)
  status       TramitationStatus @default(PENDENTE)
  observations String?           @db.Text

  createdBy     String
  createdByUser User     @relation("TramitationCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([processNumber])
  @@index([deadline])
  @@index([status])
  @@index([sectorId])
  @@index([memberId])
  @@map("CCR_Tramitation")
  @@schema("jurfis")
}

// ============================================
// TABELA DE DOCUMENTOS
// ============================================
model Document {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  type           DocumentType
  title          String
  description    String?      @db.Text
  fileName       String
  storedFileName String
  filePath       String
  fileSize       Int
  mimeType       String

  uploadedBy     String
  uploadedByUser User     @relation("DocumentUploadedBy", fields: [uploadedBy], references: [id])
  uploadedAt     DateTime @default(now())

  @@index([resourceId])
  @@index([type])
  @@map("CCR_Document")
  @@schema("jurfis")
}

// ============================================
// HISTÓRICO
// ============================================
model ResourceHistory {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  action      HistoryAction
  description String        @db.Text
  metadata    Json?
  isManual    Boolean       @default(false)

  createdBy     String
  createdByUser User     @relation("HistoryCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())

  @@index([resourceId])
  @@index([createdAt])
  @@index([isManual])
  @@map("CCR_ResourceHistory")
  @@schema("jurfis")
}

// ============================================
// TABELA DE SESSÕES E RELACIONAMENTO
// ============================================
model Session {
  //tabela de informações da sessão
  id             String @id @default(uuid())
  sessionNumber  String @unique // "XXXX/YYYY"
  sequenceNumber Int // XXXX
  year           Int // YYYY
  ordinalNumber  Int // Número sequencial contínuo por tipo (não reseta anualmente)

  date      DateTime
  startTime String? // Formato: "14:00"
  endTime   String? // Formato: "17:00"
  type      SessionType // ORDINARIA, EXTRAORDINARIA
  status    SessionStatus @default(PUBLICACAO)

  // Presidente da sessão (membro conselheiro)
  presidentId String?
  president   Member? @relation("SessionPresident", fields: [presidentId], references: [id])

  observations          String? @db.Text
  administrativeMatters String? @db.Text

  resources      SessionResource[]
  members        SessionMember[] // Membros presentes na sessão
  distributions  SessionDistribution[] @relation("DistributionsSessions")
  minutes        SessionMinutes? // Ata da sessão (gerada após a sessão)
  publications   Publication[] // Publicações da pauta (type=SESSAO) e outros documentos
  sessionVotes   SessionVote[]         @relation("VotesInSession") // Votos individuais
  resultsJudged  SessionResult[]       @relation("SessionResultsJudged") // Resultados julgados nesta sessão

  createdBy     String
  createdByUser User     @relation("SessionCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([date])
  @@index([status])
  @@index([presidentId])
  @@index([year, sequenceNumber])
  @@index([type, ordinalNumber])
  @@map("CCR_Session")
  @@schema("jurfis")
}

model SessionMember {
  //tabela de conselheiros presentes na sessão
  id        String  @id @default(uuid())
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  memberId  String
  member    Member  @relation("SessionMembersPresent", fields: [memberId], references: [id])

  createdAt DateTime @default(now())

  @@unique([sessionId, memberId])
  @@index([sessionId])
  @@index([memberId])
  @@map("CCR_SessionMember")
  @@schema("jurfis")
}

model SessionResourceAttendance {
  //tabela de presenças de partes na sessão
  id String @id @default(uuid())

  sessionResourceId String
  sessionResource   SessionResource @relation(fields: [sessionResourceId], references: [id], onDelete: Cascade)

  // Pode ser uma parte cadastrada OU uma pessoa não cadastrada
  partId String? // Opcional - se for uma parte cadastrada do sistema
  part   Part?   @relation(fields: [partId], references: [id])

  // Campos para pessoas não cadastradas
  customName String? // Nome da pessoa (se não for parte cadastrada)
  customRole String? // Tipo (ex: Advogado, Requerente, etc)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionResourceId])
  @@index([partId])
  @@map("CCR_SessionResourceAttendance")
  @@schema("jurfis")
}

model SessionResourceAbsence {
  //tabela de ausências de membros durante o julgamento de um processo específico
  id String @id @default(uuid())

  sessionResourceId String
  sessionResource   SessionResource @relation(fields: [sessionResourceId], references: [id], onDelete: Cascade)

  memberId String
  member   Member @relation("SessionResourceAbsences", fields: [memberId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionResourceId, memberId])
  @@index([sessionResourceId])
  @@index([memberId])
  @@map("CCR_SessionResourceAbsence")
  @@schema("jurfis")
}

model SessionResource {
  //tabela de recursos incluídos na sessão
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  sessionId  String
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  order  Int // Ordem na pauta
  status SessionResourceStatus // EM_PAUTA, SUSPENSO, DILIGENCIA, PEDIDO_VISTA, JULGADO

  // Flag para indicar se foi adicionado após a última publicação
  addedAfterLastPublication Boolean @default(true)

  // Presidente específico para este julgamento (opcional)
  specificPresidentId String?
  specificPresident   Member? @relation("SessionResourcePresident", fields: [specificPresidentId], references: [id])

  // Texto da ata específico deste processo
  minutesText String? @db.Text

  // Prazo de diligência (em dias)
  diligenceDaysDeadline Int?

  // Membro que pediu vista
  viewRequestedById String?
  viewRequestedBy   Member? @relation("SessionResourceViewRequests", fields: [viewRequestedById], references: [id])

  // Relacionamentos
  sessionVotes SessionVote[]                 @relation("SessionResourceVotes") // Votos individuais no contexto desta sessão
  attendances  SessionResourceAttendance[] // Presenças de partes no julgamento
  absences     SessionResourceAbsence[] // Ausências de membros no julgamento

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceId, sessionId])
  @@index([sessionId])
  @@index([status])
  @@index([specificPresidentId])
  @@index([viewRequestedById])
  @@map("CCR_SessionResource")
  @@schema("jurfis")
}

model SessionDistribution {
  //tabela de registro das distribuições dos recursos nas sessões
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  // Campos de distribuição
  firstDistributionId String? // ID do primeiro membro distribuído (relator)
  firstDistribution   Member?  @relation("DistributionFirstMember", fields: [firstDistributionId], references: [id])
  distributedToId     String // ID do membro para quem foi distribuído NESTA sessão
  reviewersIds        String[] @default([]) // IDs dos revisores na ordem (acumulativo)

  // Informações da distribuição
  sessionId         String
  session           Session @relation("DistributionsSessions", fields: [sessionId], references: [id])
  distributionOrder Int // Ordem na pauta
  isActive          Boolean @default(true)

  // Relacionamento com atas
  minutesDistributions SessionMinutesDistribution[] @relation("MinutesDistributions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId])
  @@index([firstDistributionId])
  @@index([distributedToId])
  @@index([sessionId])
  @@index([isActive])
  @@map("CCR_SessionDistribution")
  @@schema("jurfis")
}

model SessionVoteDecision {
  //tabela dos modelos de votos da sessão
  id         String       @id @default(uuid())
  type       DecisionType
  identifier String // Identificador principal (ex: intempestividade, provimento, redução de ofício)

  // Para PRELIMINAR: textos diferentes se acatar ou afastar
  acceptText String? @db.Text // Texto quando a preliminar é ACATADA
  rejectText String? @db.Text // Texto quando a preliminar é AFASTADA

  // Para MERITO e OFICIO: texto único
  text String? @db.Text // Texto padrão para mérito e ofício

  isActive Boolean @default(true)

  // Relacionamentos com votos
  votePreliminarDecisions   SessionVote[]   @relation("VotePreliminarDecisions")
  voteMeritoDecisions       SessionVote[]   @relation("VoteMeritoDecisions")
  voteOficioDecisions       SessionVote[]   @relation("VoteOficioDecisions")
  votingPreliminarDecisions SessionResult[] @relation("VotingPreliminarDecisions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier])
  @@index([type])
  @@index([isActive])
  @@map("CCR_SessionVoteDecision")
  @@schema("jurfis")
}

// Tabela de votos individuais (como cada membro votou)
model SessionVote {
  id                String          @id @default(uuid())
  sessionResourceId String
  sessionResource   SessionResource @relation("SessionResourceVotes", fields: [sessionResourceId], references: [id], onDelete: Cascade)

  memberId String
  member   Member @relation("MemberSessionVotes", fields: [memberId], references: [id])

  sessionId String
  session   Session @relation("VotesInSession", fields: [sessionId], references: [id])

  voteType            VoteType
  participationStatus ParticipationStatus

  // Voto que está sendo seguido (ao invés de followsMemberId)
  followsVoteId   String?
  followsVote     SessionVote?  @relation("FollowedVotes", fields: [followsVoteId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  votesFollowing  SessionVote[] @relation("FollowedVotes")

  // Tipo de conhecimento
  voteKnowledgeType String // "NAO_CONHECIMENTO" | "CONHECIMENTO"

  // Decisões selecionadas (IDs dos modelos padrão)
  preliminaryDecisionId   String?
  preliminaryDecision     SessionVoteDecision? @relation("VotePreliminarDecisions", fields: [preliminaryDecisionId], references: [id])
  preliminaryDecisionType String? // "ACATAR" | "AFASTAR" - Sentido da preliminar para votos de não conhecimento

  meritDecisionId String?
  meritDecision   SessionVoteDecision? @relation("VoteMeritoDecisions", fields: [meritDecisionId], references: [id])

  officialDecisionId String?
  officialDecision   SessionVoteDecision? @relation("VoteOficioDecisions", fields: [officialDecisionId], references: [id])

  // Texto único consolidado (preliminar + mérito + ofício)
  voteText String? @db.Text

  // Vínculo com resultado (preenchido quando votação for concluída)
  sessionResultId String?
  sessionResult   SessionResult? @relation(fields: [sessionResultId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionResourceId])
  @@index([memberId])
  @@index([sessionId])
  @@index([sessionResultId])
  @@index([preliminaryDecisionId])
  @@index([meritDecisionId])
  @@index([officialDecisionId])
  @@index([followsVoteId])
  @@map("CCR_SessionVote")
  @@schema("jurfis")
}

// Tabela de resultados (resultado consolidado da votação)
model SessionResult {
  id         String   @id @default(uuid())
  resourceId String   // Vinculado ao processo (Resource) para agregar votos de múltiplas sessões
  resource   Resource @relation("ResourceSessionResults", fields: [resourceId], references: [id], onDelete: Cascade)

  votingType String // "NAO_CONHECIMENTO", "CONHECIMENTO", "MERITO"
  order      Int     @default(1) // Ordem de apresentação da votação (para ordenar cronologicamente)

  // Se for votação de não conhecimento com preliminar específica
  preliminaryDecisionId String?
  preliminaryDecision   SessionVoteDecision? @relation("VotingPreliminarDecisions", fields: [preliminaryDecisionId], references: [id])

  // Status da votação
  status String @default("PENDENTE") // "PENDENTE", "CONCLUIDA"

  // Sessão onde a votação foi concluída/julgada
  judgedInSessionId String?
  judgedInSession   Session? @relation("SessionResultsJudged", fields: [judgedInSessionId], references: [id])

  // Resultado (quando concluída)
  winningVoteId   String?
  winningMemberId String?
  winningMember   Member? @relation("VotingWinnerMembers", fields: [winningMemberId], references: [id])

  // Contagem de votos
  totalVotes Int @default(0) // Total de votos válidos (conselheiros + presidente se houver)

  // Contagem de participação
  abstentions Int @default(0) // Abstenções (presente mas não votou)
  absences    Int @default(0) // Ausentes
  impediments Int @default(0) // Impedidos
  suspicions  Int @default(0) // Suspeitos

  // Voto de qualidade
  qualityVoteUsed     Boolean @default(false)
  qualityVoteMemberId String?
  qualityVoteMember   Member? @relation("QualityVoteMembers", fields: [qualityVoteMemberId], references: [id])

  // Texto final consolidado
  finalText String? @db.Text

  // Votos relacionados (de múltiplas sessões)
  votes SessionVote[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Garantir apenas um resultado por tipo de votação + preliminar (se houver) por processo
  @@unique([resourceId, votingType, preliminaryDecisionId])
  @@index([resourceId])
  @@index([resourceId, order])
  @@index([votingType])
  @@index([status])
  @@index([preliminaryDecisionId])
  @@index([judgedInSessionId])
  @@index([winningMemberId])
  @@index([qualityVoteMemberId])
  @@map("CCR_SessionResult")
  @@schema("jurfis")
}

// ============================================
// TABELA DE ATAS E RELACIONAMENTO
// ============================================
model SessionMinutes {
  id String @id @default(uuid())

  sessionId String?  @unique
  session   Session? @relation(fields: [sessionId], references: [id])

  minutesNumber  String @unique
  sequenceNumber Int
  year           Int

  ordinalNumber Int
  ordinalType   SessionType

  presidentId String?
  president   Member? @relation("MinutesPresident", fields: [presidentId], references: [id])

  endTime String

  administrativeMatters String? @db.Text

  distributions  SessionMinutesDistribution[]
  presentMembers SessionMinutesMember[]
  absentMembers  SessionMinutesAbsence[]

  createdBy     String
  createdByUser User     @relation("MinutesCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([year, sequenceNumber])
  @@index([ordinalType, ordinalNumber])
  @@index([sessionId])
  @@index([presidentId])
  @@map("CCR_SessionMinutes")
  @@schema("jurfis")
}

model SessionMinutesDistribution {
  id             String              @id @default(uuid())
  minutesId      String
  minutes        SessionMinutes      @relation(fields: [minutesId], references: [id], onDelete: Cascade)
  distributionId String
  distribution   SessionDistribution @relation("MinutesDistributions", fields: [distributionId], references: [id])

  createdAt DateTime @default(now())

  @@unique([minutesId, distributionId])
  @@index([minutesId])
  @@index([distributionId])
  @@map("CCR_SessionMinutesDistribution")
  @@schema("jurfis")
}

model SessionMinutesMember {
  id        String         @id @default(uuid())
  minutesId String
  minutes   SessionMinutes @relation(fields: [minutesId], references: [id], onDelete: Cascade)
  memberId  String
  member    Member         @relation("MinutesMembersPresent", fields: [memberId], references: [id])

  createdAt DateTime @default(now())

  @@unique([minutesId, memberId])
  @@index([minutesId])
  @@index([memberId])
  @@map("CCR_SessionMinutesMember")
  @@schema("jurfis")
}

model SessionMinutesAbsence {
  id        String         @id @default(uuid())
  minutesId String
  minutes   SessionMinutes @relation(fields: [minutesId], references: [id], onDelete: Cascade)
  memberId  String
  member    Member         @relation("MinutesAbsences", fields: [memberId], references: [id])

  isJustified   Boolean @default(false)
  justification String? @db.Text

  createdAt DateTime @default(now())

  @@unique([minutesId, memberId])
  @@index([minutesId])
  @@index([memberId])
  @@index([isJustified])
  @@map("CCR_SessionMinutesAbsence")
  @@schema("jurfis")
}

// ============================================
// TABELA DE NOTIFICAÇÕES
// ============================================
model Notification {
  id         String    @id @default(uuid())
  resourceId String?
  resource   Resource? @relation(fields: [resourceId], references: [id])

  type NotificationType

  sectorId String?
  sector   Sector? @relation(fields: [sectorId], references: [id])

  destination String?

  subject String
  message String @db.Text

  scheduledFor DateTime?
  status       NotificationStatus @default(PENDENTE)

  contacts NotificationContact[]

  createdBy     String
  createdByUser User     @relation("NotificationCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([resourceId])
  @@index([sectorId])
  @@map("CCR_Notification")
  @@schema("jurfis")
}

model NotificationContact {
  id             String       @id @default(uuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  channel NotificationChannel
  contact String?

  attemptCount  Int       @default(0)
  lastAttemptAt DateTime?

  status      NotificationContactStatus @default(PENDENTE)
  sentAt      DateTime?
  deliveredAt DateTime?
  confirmedAt DateTime?

  error        String? @db.Text
  observations String? @db.Text

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([notificationId])
  @@index([channel])
  @@index([status])
  @@map("CCR_NotificationContact")
  @@schema("jurfis")
}

// ============================================
// TABELA DE ASSUNTOS E RELACIONAMENTO
// ============================================
model Subject {
  id          String  @id @default(uuid())
  name        String // Nome do assunto (ex: "Isenção de IPTU", "Possui renda superior a 2 salários mínimos")
  description String? @db.Text
  isActive    Boolean @default(true)

  // Hierarquia: Assunto principal → Subitens (motivos)
  parentId String? // Null = assunto principal, preenchido = subitem
  parent   Subject?  @relation("SubjectHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children Subject[] @relation("SubjectHierarchy")

  // Relacionamentos com recursos
  resourceLinks SubjectChildren[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([parentId])
  @@map("CCR_Subject")
  @@schema("jurfis")
}

model SubjectChildren {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  subjectId  String
  subject    Subject  @relation(fields: [subjectId], references: [id])

  // Marcador de assunto principal
  isPrimary Boolean @default(false) // True = assunto principal do recurso, False = subitem/motivo

  createdAt DateTime @default(now())

  @@unique([resourceId, subjectId])
  @@index([resourceId])
  @@index([subjectId])
  @@index([isPrimary])
  @@map("CCR_SubjectChildren")
  @@schema("jurfis")
}

// ============================================
// TABELA DE AUTORIDADES E RELACIONAMENTO
// ============================================
model Authority {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  type AuthorityType // Tipo de autoridade

  authorityRegisteredId String
  authorityRegistered   AuthorityRegistered @relation(fields: [authorityRegisteredId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId])
  @@index([type])
  @@index([authorityRegisteredId])
  @@map("CCR_Authority")
  @@schema("jurfis")
}

model AuthorityRegistered {
  id       String  @id @default(uuid())
  name     String // Nome completo da autoridade
  phone    String? // Telefone
  email    String? // Email
  isActive Boolean @default(true)

  // Relacionamentos
  authorities Authority[] // Autoridades vinculadas aos recursos

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([name])
  @@map("CCR_AuthorityRegistered")
  @@schema("jurfis")
}

// ============================================
// TABELA DE MEMBROS
// ============================================
model Member {
  id           String  @id @default(uuid())
  name         String // Nome completo do membro
  role         String? // Cargo (ex: "Presidente", "Conselheiro Titular", etc)
  cpf          String? // CPF
  registration String? // Matrícula
  agency       String? // Órgão
  phone        String?
  email        String?
  gender       Gender? // MASCULINO ou FEMININO
  isActive     Boolean @default(true)

  // Relacionamentos
  tramitations                Tramitation[]
  sessionsAsPresident         Session[]                  @relation("SessionPresident")
  sessionsPresent             SessionMember[]            @relation("SessionMembersPresent")
  sessionResourcesAsPresident SessionResource[]          @relation("SessionResourcePresident")
  sessionResourceViewRequests SessionResource[]          @relation("SessionResourceViewRequests")
  sessionResourceAbsences     SessionResourceAbsence[]   @relation("SessionResourceAbsences")
  distributionsAsFirst        SessionDistribution[]      @relation("DistributionFirstMember")
  minutesAsPresident          SessionMinutes[]           @relation("MinutesPresident")
  minutesPresent              SessionMinutesMember[]     @relation("MinutesMembersPresent")
  minutesAbsences             SessionMinutesAbsence[]    @relation("MinutesAbsences")

  // Novos relacionamentos
  sessionVotes      SessionVote[]   @relation("MemberSessionVotes")
  votingsWon        SessionResult[] @relation("VotingWinnerMembers")
  qualityVotesGiven SessionResult[] @relation("QualityVoteMembers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@map("CCR_Member")
  @@schema("jurfis")
}

// ============================================
// TABELA DE SETORES E RELACIONAMENTO
// ============================================
model Sector {
  id           String  @id @default(uuid())
  name         String  @unique // Nome completo do setor (ex: "Fiscalização", "Contencioso")
  abbreviation String? @unique // Abreviação do setor (ex: "FISC", "CONT")
  dispatchCode String? // Código identificador para despacho
  description  String? @db.Text

  // Informações de contato
  phone   String?
  email   String?
  address String? @db.Text

  isActive Boolean @default(true)

  // Relacionamentos
  tramitations  Tramitation[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@map("CCR_Sector")
  @@schema("jurfis")
}

// ============================================
// ENUMS
// ============================================
enum PartRole {
  REQUERENTE
  PATRONO
  REPRESENTANTE
  OUTRO

  @@schema("jurfis")
}

enum ContactType {
  TELEFONE
  EMAIL

  @@schema("jurfis")
}

enum ProtocolStatus {
  PENDENTE
  CONCLUIDO
  ARQUIVADO

  @@schema("jurfis")
}

enum ResourceStatus {
  EM_ANALISE
  TEMPESTIVIDADE
  CONTRARRAZAO
  PARECER_PGM
  DISTRIBUICAO
  NOTIFICACAO_JULGAMENTO
  JULGAMENTO
  DILIGENCIA
  PEDIDO_VISTA
  SUSPENSO
  PUBLICACAO_ACORDAO
  ASSINATURA_ACORDAO
  NOTIFICACAO_DECISAO
  CONCLUIDO

  @@schema("jurfis")
}

enum ResourceType {
  VOLUNTARIO
  OFICIO

  @@schema("jurfis")
}

enum AddressType {
  CORRESPONDENCIA
  RECURSO
  OUTRO

  @@schema("jurfis")
}

enum PublicationType {
  SESSAO
  ACORDAO
  CIENCIA

  @@schema("jurfis")
}

enum RegistrationType {
  IMOBILIARIA
  ECONOMICA
  CPF
  CNPJ

  @@schema("jurfis")
}

enum TramitationPurpose {
  SOLICITAR_PROCESSO
  CONTRARRAZAO
  PARECER_PGM
  JULGAMENTO
  DILIGENCIA
  OUTRO

  @@schema("jurfis")
}

enum TramitationStatus {
  PENDENTE
  ENTREGUE

  @@schema("jurfis")
}

enum DocumentType {
  RECURSO
  CONTRARRAZAO
  PARECER
  VOTO
  OUTROS

  @@schema("jurfis")
}

enum HistoryAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  DOCUMENT_ADDED
  SESSION_ADDED
  NOTIFICATION_SENT
  TRAMITATION_ADDED

  @@schema("jurfis")
}

enum SessionType {
  ORDINARIA
  EXTRAORDINARIA
  OUTRO

  @@schema("jurfis")
}

enum SessionStatus {
  PUBLICACAO // Aguardando publicação da pauta ou republicação após alterações
  PENDENTE // Pauta publicada, aguardando sessão e julgamentos
  CONCLUIDA // Sessão finalizada
  CANCELADA // Sessão cancelada

  @@schema("jurfis")
}

enum SessionResourceStatus {
  EM_PAUTA
  SUSPENSO
  DILIGENCIA
  PEDIDO_VISTA
  JULGADO

  @@schema("jurfis")
}

enum DistributionType {
  RELATOR
  REVISOR

  @@schema("jurfis")
}

enum DecisionType {
  PRELIMINAR
  MERITO
  OFICIO

  @@schema("jurfis")
}

enum VotingType {
  PRELIMINAR
  MERITO

  @@schema("jurfis")
}

enum VoteType {
  RELATOR
  REVISOR
  PRESIDENTE
  VOTANTE

  @@schema("jurfis")
}

enum ParticipationStatus {
  PRESENTE
  IMPEDIDO
  SUSPEITO
  ABSTENCAO

  @@schema("jurfis")
}

enum NotificationType {
  ADMISSIBILIDADE
  SESSAO
  DILIGENCIA
  DECISAO
  OUTRO

  @@schema("jurfis")
}

enum NotificationStatus {
  PENDENTE
  ENVIADO
  ERRO
  AGENDADO

  @@schema("jurfis")
}

enum NotificationContactStatus {
  PENDENTE
  ENVIADO
  ENTREGUE
  CONFIRMADO
  ERRO

  @@schema("jurfis")
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
  CORREIOS
  EDITAL

  @@schema("jurfis")
}

enum AuthorityType {
  AUTOR_PROCEDIMENTO_FISCAL
  JULGADOR_SINGULAR
  COORDENADOR
  OUTROS

  @@schema("jurfis")
}

enum Gender {
  MASCULINO
  FEMININO

  @@schema("jurfis")
}
